<div class="wy-music-parser">
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸï¼šå±•ç¤ºç½‘ç«™åç§°å’Œæè¿° -->
    <header class="parser-header">
        <h1 class="site-title">ç½‘æ˜“äº‘éŸ³ä¹æ— æŸè§£æ</h1>
        <p class="site-desc">æ°¸ä¹…å…è´¹çš„ç½‘æ˜“äº‘éŸ³ä¹é«˜å“è´¨è§£æ</p>
    </header>
    
    <!-- ä¸»ä½“å†…å®¹åŒºåŸŸï¼šåŒ…å«æ ¸å¿ƒåŠŸèƒ½æ¨¡å— -->
    <main class="parser-main">
        <!-- è§£ææ–¹å¼é€‰æ‹©ï¼šæ­Œæ›²è§£æ/æ­Œå•è§£æåˆ‡æ¢ -->
        <div class="parse-methods">
            <h2 class="section-title">é€‰æ‹©è§£ææ–¹å¼</h2>
            <div class="method-selector">
                <button class="method-tab active" data-method="link">æ­Œæ›²è§£æ</button>
                <button class="method-tab" data-method="playlist">æ­Œå•è§£æ</button>
            </div>
        </div>
        
        <!-- è§£æè¡¨å•ï¼šè¾“å…¥æ¡†ã€éŸ³è´¨é€‰æ‹©ã€è§£ææŒ‰é’® -->
        <div class="parse-form">
            <div class="input-section">
                <div class="input-group">
                    <input type="text" id="musicInput" class="music-input" placeholder="è¯·è¾“å…¥ç½‘æ˜“äº‘éŸ³ä¹é“¾æ¥æˆ–ID" />
                </div>
                
                <!-- éŸ³è´¨é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼šæä¾›ä¸åŒéŸ³è´¨é€‰é¡¹ -->
                <select id="qualitySelect" class="quality-select">
                    <option value="standard">æ ‡å‡†éŸ³è´¨</option>
                    <option value="higher">è¾ƒé«˜éŸ³è´¨</option>
                    <option value="exhigh">æé«˜éŸ³è´¨</option>
                    <option value="lossless">æ— æŸéŸ³è´¨</option>
                    <option value="hires">Hi-ReséŸ³è´¨</option>
                </select>
                
                <!-- è§£ææŒ‰é’®ï¼šè§¦å‘è§£ææ“ä½œ -->
                <button id="parseButton" class="parse-button">è§£æ</button>
            </div>
        </div>
        
        <!-- ç»“æœå±•ç¤ºåŒºåŸŸï¼šåˆå§‹æ˜¾ç¤ºæç¤ºï¼Œè§£æåå±•ç¤ºç»“æœ -->
        <div id="resultContainer" class="result-container">
            <div class="initial-hint">
                <p>è¯·åœ¨ä¸Šæ–¹è¾“å…¥ç½‘æ˜“äº‘éŸ³ä¹é“¾æ¥æˆ–IDè¿›è¡Œè§£æ</p>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸï¼šåŠ è½½ä¸­/è§£æå¤±è´¥çŠ¶æ€ï¼Œé»˜è®¤éšè— -->
        <div id="statusContainer" class="status-container" style="display: none;">
            <div id="loadingState" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
            <div id="errorState" class="error" style="display: none;">è§£æå¤±è´¥ï¼Œè¯·é‡è¯•</div>
        </div>
        
        <!-- æ”¯æŒæ ¼å¼åŒºåŸŸï¼šå±•ç¤ºå¯è§£æçš„é“¾æ¥/IDæ ¼å¼ -->
        <div class="supported-formats">
            <h2 class="section-title">ğŸ“‹ æ”¯æŒæ ¼å¼</h2>
            <ul class="format-list">
                <li>music.163.com/song?id=xxx</li>
                <li>y.music.163.com/m/song/xxx</li>
                <li>music.163.com/#/song?id=xxx</li>
                <li>music.163.com/playlist?id=xxx</li>
                <li>y.music.163.com/m/playlist/xxx</li>
                <li>music.163.com/#/playlist?id=xxx</li>
                <li>163cn.tv/xxx</li>
                <li>æ­Œæ›²IDã€æ­Œå•ID</li>
            </ul>
        </div>
    </main>
    
    <!-- é¡µè„šä¿¡æ¯ï¼šå…è´£å£°æ˜ï¼Œæç¤ºæ”¯æŒæ­£ç‰ˆ -->
    <footer class="parser-footer">
        <div class="footer-content">
            <div class="disclaimer">
                <p><strong>å…è´£å£°æ˜</strong>ï¼šæœ¬å·¥å…·ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·æ”¯æŒæ­£ç‰ˆéŸ³ä¹ã€‚ä½¿ç”¨æœ¬å·¥å…·æ—¶è¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå°Šé‡éŸ³ä¹äººçš„åŠ³åŠ¨æˆæœã€‚</p>
            </div>
        </div>
    </footer>
</div>

<style>
    /* ç½‘æ˜“äº‘éŸ³ä¹è§£æå™¨æ ·å¼éš”ç¦» - é¿å…ä¸å…¨å±€æ ·å¼å†²çª */
    
    /* CSSå˜é‡éš”ç¦» */
    .wy-music-parser {
        --color-primary: #6C4AB6; /* ä¸»è‰²è°ƒï¼šæ·±ç´«è‰² */
        --color-primary-light: #8D72E1;
        --color-primary-dark: #5A3CA0;
        --color-text: #E0E0E0; /* æ–‡å­—ä¸»è‰² */
        --color-text-secondary: #A0A0A0; /* æ¬¡è¦æ–‡å­—è‰² */
        --color-background: #121212; /* é¡µé¢èƒŒæ™¯ */
        --color-surface: #1E1E1E; /* å¡ç‰‡èƒŒæ™¯ */
        --color-surface-light: #2D2D2D; /* æµ…èƒŒæ™¯ */
        --color-border: #333333; /* è¾¹æ¡†è‰² */
        --color-error: #FF4D4F; /* é”™è¯¯æç¤ºè‰² */
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --border-radius-sm: 4px;
        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
        --transition-normal: all 0.3s ease;
    }

    /* æ ·å¼éš”ç¦» - ç¡®ä¿å…ƒç´ ä¸å—å¤–éƒ¨æ ·å¼è¿‡å¤§å½±å“ï¼Œä½†ä¿æŒåŸºæœ¬æ¸²æŸ“ */
    .wy-music-parser {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        position: relative;
        z-index: 1;
    }
    
    /* å¯¹å®¹å™¨å†…å…ƒç´ åº”ç”¨åˆç†çš„æ ·å¼é‡ç½® */
    .wy-music-parser > * {
        box-sizing: border-box;
    }
    
    /* ç¡®ä¿wy-playlist-headerå’Œplaylist-infoèƒ½æ­£å¸¸æ˜¾ç¤º */
    .wy-music-parser .wy-playlist-header {
        display: flex !important;
    }
    
    .wy-music-parser .playlist-info {
        display: block !important;
        flex: 1 !important;
    }
    
    /* æ›´åˆç†çš„å…ƒç´ æ ·å¼é‡ç½® */
    .wy-music-parser button,
    .wy-music-parser input,
    .wy-music-parser select {
        /* ä¿ç•™åŸºæœ¬çš„å…ƒç´ ç‰¹æ€§ */
        box-sizing: border-box !important;
    }
    
    /* ç¡®ä¿å›¾ç‰‡å’Œä¼ªå…ƒç´ èƒ½æ­£å¸¸å·¥ä½œ */
    .wy-music-parser img {
        /* å…è®¸å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º */
        max-width: 100% !important;
        max-height: 100% !important;
    }
    
    /* å…è®¸ä¼ªå…ƒç´ æ­£å¸¸å·¥ä½œ */
    .wy-music-parser *:before,
    .wy-music-parser *:after {
        content: "";
    }
    /* ç§»é™¤ç¦æ­¢contentçš„è§„åˆ™ */
    
    /* é‡æ–°å®šä¹‰åŸºç¡€æ ·å¼ */
    .wy-music-parser {
        background-color: var(--color-surface);
        color: var(--color-text);
        line-height: 1.6;
    }
    
    .wy-music-parser button {
        cursor: pointer;
    }
    
    .wy-music-parser input,
    .wy-music-parser select {
        background-color: var(--color-surface-light);
        color: var(--color-text);
    }
    
    .wy-music-parser table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .wy-music-parser ul {
        list-style: none;
    }

    /* ä¸»å®¹å™¨æ ·å¼ */
    .wy-music-parser {
        max-width: 1000px;
        margin: 0 auto;
        background-color: var(--color-surface);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    /* é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ */
    .parser-header {
        text-align: center;
        padding: var(--spacing-xl) 0;
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        color: white;
    }

    .site-title {
        font-size: 2.2rem;
        margin-bottom: var(--spacing-sm);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .site-desc {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
    }

    /* è§£ææ–¹å¼é€‰æ‹©å™¨æ ·å¼ */
    .parse-methods {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
    }

    .section-title {
        font-size: 1.4rem;
        margin-bottom: var(--spacing-md);
        color: var(--color-text);
    }

    .method-selector {
        display: flex;
        background-color: var(--color-surface-light);
        border-radius: var(--border-radius-md);
        overflow: hidden;
    }

    .method-tab {
        flex: 1;
        padding: var(--spacing-md);
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        color: var(--color-text-secondary);
        transition: var(--transition-normal);
    }

    .method-tab:hover {
        color: var(--color-text);
        background-color: rgba(108, 74, 182, 0.1);
    }

    .method-tab.active {
        background-color: var(--color-primary);
        color: white;
    }

    /* è§£æè¡¨å•æ ·å¼ */
    .parse-form {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
    }

    .input-section {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    .input-group {
        flex: 1;
    }

    #musicInput {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-md);
        background-color: var(--color-surface-light);
        color: var(--color-text);
        font-size: 1rem;
        transition: var(--transition-normal);
    }

    #musicInput:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(108, 74, 182, 0.2);
    }

    #qualitySelect {
        padding: 12px 16px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-md);
        background-color: var(--color-surface-light);
        color: var(--color-text);
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition-normal);
        min-width: 150px;
    }

    #qualitySelect:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    #parseButton {
        padding: 12px 24px;
        background-color: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-normal);
    }

    #parseButton:hover {
        background-color: var(--color-primary-light);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    /* ç»“æœå®¹å™¨æ ·å¼ */
    .result-container {
        padding: var(--spacing-lg);
        min-height: 200px;
    }

    .initial-hint {
        text-align: center;
        padding: var(--spacing-xl) 0;
        color: var(--color-text-secondary);
    }

    /* æ­Œæ›²ç»“æœæ ·å¼ */
    .song-result {
        animation: fadeIn 0.5s ease;
    }

    .song-content {
        display: flex;
        gap: var(--spacing-lg);
        align-items: center;
    }

    .song-cover .cover-img {
        width: 160px;
        height: 160px;
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        background-color: var(--color-surface-light);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .song-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .song-cover .cover-placeholder {
        font-size: 48px;
        color: var(--color-primary-light);
    }

    .song-info {
        flex: 1;
    }

    .song-title {
        font-size: 1.8rem;
        margin-bottom: var(--spacing-sm);
        color: var(--color-text);
    }

    .song-artist, .song-album {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .song-meta {
        display: flex;
        gap: var(--spacing-lg);
        margin: var(--spacing-md) 0;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--color-text-secondary);
    }

    .song-actions {
        display: flex;
        gap: var(--spacing-md);
    }

    .play-button, .download-button {
        padding: 10px 20px;
        border: none;
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition-normal);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .play-button {
        background-color: #1890ff;
        color: white;
    }

    .play-button:hover {
        background-color: #40a9ff;
    }

    .download-button {
        background-color: #52c41a;
        color: white;
    }

    .download-button:hover {
        background-color: #73d13d;
    }

    /* æ­Œå•ç»“æœæ ·å¼ */
    .playlist-result {
        animation: fadeIn 0.5s ease;
    }

    .wy-playlist-header {
        display: flex !important;
        gap: 20px !important;
        margin-bottom: 20px !important;
        align-items: flex-start !important;
        width: 100% !important;
    }

    .playlist-cover {
        width: 180px;
        height: 180px;
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        background-color: var(--color-surface-light);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .playlist-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .playlist-cover .cover-placeholder {
        font-size: 48px;
        color: var(--color-primary-light);
    }

    .playlist-info {
        flex: 1;
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-width: 0; /* é˜²æ­¢flexå­å…ƒç´ æº¢å‡º */
    }

    .playlist-info h2 {
        font-size: 1.8rem;
        margin-bottom: var(--spacing-md);
    }

    .playlist-info p {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .play-all-button {
        padding: 10px 20px;
        background-color: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition-normal);
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: var(--spacing-md);
    }

    .play-all-button:hover {
        background-color: var(--color-primary-light);
    }

    /* æ­Œæ›²åˆ—è¡¨è¡¨æ ¼æ ·å¼ */
    .tracks-container {
        overflow-x: auto;
    }

    .tracks-table {
        width: 100%;
        border-collapse: collapse;
    }

    .tracks-table th,
    .tracks-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
    }

    .tracks-table th {
        background-color: var(--color-surface-light);
        color: var(--color-text);
        font-weight: 500;
    }

    .tracks-table tr:hover td {
        background-color: rgba(108, 74, 182, 0.1);
    }

    .col-index {
        width: 60px;
        text-align: center;
        color: var(--color-text-secondary);
    }

    .col-title {
        color: var(--color-text);
    }

    .col-artist, .col-album {
        color: var(--color-text-secondary);
    }

    .track-play-button {
        background: none;
        border: none;
        color: var(--color-primary);
        cursor: pointer;
        font-size: 1.2rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-normal);
    }

    .track-play-button:hover {
        background-color: rgba(108, 74, 182, 0.2);
    }

    /* æ”¯æŒæ ¼å¼åŒºåŸŸ */
    .supported-formats {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--color-border);
        background-color: var(--color-surface-light);
    }

    .format-list {
        list-style: none;
        padding-left: var(--spacing-md);
    }

    .format-list li {
        margin-bottom: var(--spacing-sm);
        position: relative;
        padding-left: 24px;
        color: var(--color-text-secondary);
    }

    .format-list li::before {
        content: 'â€¢';
        color: var(--color-primary);
        position: absolute;
        left: 0;
    }

    /* é¡µè„šæ ·å¼ */
    .parser-footer {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--color-border);
        background-color: var(--color-surface-light);
    }

    .disclaimer {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        text-align: center;
    }

    /* çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
    .status-container {
        text-align: center;
        padding: var(--spacing-lg);
    }

    .loading {
        color: var(--color-text-secondary);
        font-size: 1.1rem;
    }

    .error {
        color: var(--color-error);
        font-size: 1.1rem;
        padding: var(--spacing-md);
        background-color: rgba(255, 77, 79, 0.1);
        border-radius: var(--border-radius-md);
    }

    .play-status {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(30, 30, 30, 0.9);
        padding: 12px 24px;
        border-radius: 30px;
        box-shadow: var(--shadow-md);
        z-index: 1000;
    }

    .playing {
        color: var(--color-text);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* å“åº”å¼é€‚é… */
    @media (max-width: 768px) {
        .input-section {
            flex-direction: column;
        }

        .input-group, #qualitySelect, #parseButton {
            width: 100%;
        }

        .song-content, .wy-playlist-header {
            flex-direction: column;
            text-align: center;
        }

        .song-actions {
            justify-content: center;
            margin-top: var(--spacing-md);
        }

        .col-album {
            display: none;
        }
    }

    @media (max-width: 480px) {
        .site-title {
            font-size: 1.8rem;
        }

        .song-cover .cover-img, .playlist-cover {
            width: 120px;
            height: 120px;
        }

        .song-title, .playlist-info h2 {
            font-size: 1.5rem;
        }

        .col-artist {
            display: none;
        }
    }
</style>

<script>
    // å…¨å±€é¡µé¢å¯¹è±¡ï¼šå­˜å‚¨æ‰€æœ‰çŠ¶æ€å’ŒåŠŸèƒ½
    window.myMusicPage = {
        currentMethod: 'link', // é»˜è®¤è§£ææ–¹å¼ï¼šæ­Œæ›²è§£æ
        currentTracks: [],     // å­˜å‚¨å½“å‰æ­Œå•çš„æ­Œæ›²åˆ—è¡¨ï¼Œç”¨äºæ’­æ”¾
        
        // é¡µé¢åˆå§‹åŒ–å‡½æ•°
    init: function() {
        // 1. è§£ææ–¹å¼åˆ‡æ¢äº‹ä»¶ï¼ˆæ­Œæ›²/æ­Œå•æ ‡ç­¾åˆ‡æ¢ï¼‰- æ·»åŠ CSSéš”ç¦»é€‰æ‹©å™¨
        const methodTabs = document.querySelectorAll('.wy-music-parser .method-tab');
        methodTabs.forEach(tab => {
            tab.onclick = function() {
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»ï¼Œç»™å½“å‰ç‚¹å‡»æ ‡ç­¾æ·»åŠ active
                methodTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // æ›´æ–°å½“å‰è§£ææ–¹å¼ä¸ºæ ‡ç­¾çš„data-methodå€¼
                window.myMusicPage.currentMethod = tab.dataset.method;
                
                // æ ¹æ®è§£ææ–¹å¼æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡å­—
                const input = document.getElementById('musicInput');
                input.placeholder = window.myMusicPage.currentMethod === 'link' 
                    ? 'è¯·è¾“å…¥ç½‘æ˜“äº‘éŸ³ä¹é“¾æ¥æˆ–ID' 
                    : 'è¯·è¾“å…¥æ­Œå•é“¾æ¥æˆ–ID';
            };
        });
        
        // 2. è§£ææŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šè§¦å‘è§£æå‡½æ•°
        document.getElementById('parseButton').onclick = window.myMusicPage.parseMusic;
        
        // 3. è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼šæŒ‰Enteré”®ä¹Ÿèƒ½è§¦å‘è§£æ
        document.getElementById('musicInput').onkeypress = function(e) {
            if (e.key === 'Enter') window.myMusicPage.parseMusic();
        };
        
        // æ¸…é™¤å¯èƒ½çš„å¤–éƒ¨äº‹ä»¶å¹²æ‰°
        document.getElementById('parseButton').onclick = window.myMusicPage.parseMusic;
    },
        
        /**
         * ä¸»è¦è§£æå‡½æ•°ï¼šç»Ÿä¸€å…¥å£ï¼Œå¤„ç†è¾“å…¥å†…å®¹å¹¶åˆ†å‘è§£æä»»åŠ¡
         */
        parseMusic: async function() {
            // è·å–è¾“å…¥æ¡†å†…å®¹å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
            const input = document.getElementById('musicInput').value.trim();
            // è¾“å…¥ä¸ºç©ºæ—¶æç¤ºé”™è¯¯
            if (!input) {
                window.myMusicPage.showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å†…å®¹');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            window.myMusicPage.showLoading();
            
            // è§£æè¾“å…¥å†…å®¹ï¼Œè¯†åˆ«æ˜¯æ­Œæ›²/æ­Œå•/ä¸“è¾‘IDæˆ–é“¾æ¥
            const parsedContent = window.myMusicPage.parseInputContent(input);
            
            try {
                // æ ¹æ®è§£æç»“æœåˆ†å‘åˆ°å¯¹åº”è§£æå‡½æ•°
                if (parsedContent.type === 'song') {
                    await window.myMusicPage.parseSong(parsedContent.id); // è§£ææ­Œæ›²
                } else if (parsedContent.type === 'playlist') {
                    await window.myMusicPage.parsePlaylist(parsedContent.id); // è§£ææ­Œå•
                } else {
                    // æ— æ³•è‡ªåŠ¨è¯†åˆ«æ—¶ï¼ŒæŒ‰å½“å‰é€‰æ‹©çš„è§£ææ–¹å¼å°è¯•è§£æ
                    window.myMusicPage.currentMethod === 'link' 
                        ? await window.myMusicPage.parseSong(input) 
                        : await window.myMusicPage.parsePlaylist(input);
                }
            } catch (error) {
                // è§£æå¤±è´¥æ—¶æ‰“å°é”™è¯¯å¹¶æç¤º
                console.error('è§£æé”™è¯¯:', error);
                window.myMusicPage.hideStatus();
                window.myMusicPage.showError('è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®');
            }
        },
        
        /**
         * è§£æè¾“å…¥å†…å®¹ï¼šæå–IDå’Œç±»å‹ï¼ˆæ­Œæ›²/æ­Œå•ï¼‰
         * @param {string} input - è¾“å…¥æ¡†å†…å®¹ï¼ˆé“¾æ¥æˆ–IDï¼‰
         * @returns {object} - {type: 'song'/'playlist'/'unknown', id: æå–çš„ID}
         */
        parseInputContent: function(input) {
            // æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é…æ­Œæ›²é“¾æ¥ä¸­çš„ID
            const songRegex = /song\?id=(\d+)|song\/(\d+)/i;
            // æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é…æ­Œå•é“¾æ¥ä¸­çš„ID
            const playlistRegex = /playlist\?id=(\d+)|playlist\/(\d+)/i;
            // æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é…çŸ­é“¾æ¥
            const shortLinkRegex = /163cn\.tv\/(\w+)/i;
            
            let match;
            
            // 1. çº¯æ•°å­—IDï¼šé»˜è®¤è§†ä¸ºæ­Œæ›²ID
            if (/^\d+$/.test(input)) {
                return { type: 'song', id: input };
            }
            
            // 2. åŒ¹é…æ­Œæ›²é“¾æ¥ï¼šæå–æ­Œæ›²ID
            if ((match = songRegex.exec(input))) {
                return { type: 'song', id: match[1] || match[2] };
            }
            
            // 3. åŒ¹é…æ­Œå•é“¾æ¥ï¼šæå–æ­Œå•ID
            if ((match = playlistRegex.exec(input))) {
                return { type: 'playlist', id: match[1] || match[2] };
            }
            
            // 4. åŒ¹é…çŸ­é“¾æ¥ï¼šç®€åŒ–å¤„ç†ä¸ºæ­Œæ›²ID
            if ((match = shortLinkRegex.exec(input))) {
                return { type: 'song', id: match[1] };
            }
            
            // æ— æ³•è¯†åˆ«çš„å†…å®¹
            return { type: 'unknown', id: input };
        },
        
        /**
         * è§£ææ­Œæ›²ï¼šè°ƒç”¨æ¥å£è·å–æ­Œæ›²ä¿¡æ¯å¹¶æ¸²æŸ“ç»“æœ
         * @param {string} id - æ­Œæ›²ID
         */
        parseSong: async function(id) {
            try {
                // æ˜¾ç¤ºçŠ¶æ€æç¤º
                window.myMusicPage.showStatus('æ­£åœ¨è·å–æ­Œæ›²ä¿¡æ¯...');
                
                // è·å–é€‰ä¸­çš„éŸ³è´¨
                const quality = document.getElementById('qualitySelect').value;
                
                // è°ƒç”¨è§£ææ¥å£è·å–æ­Œæ›²ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨jxæ¥å£ï¼‰
                const response = await fetch(`/music/jx?ids=${id}&level=${quality}&type=json`);
                const data = await response.json();
                
                // éšè—çŠ¶æ€æç¤º
                window.myMusicPage.hideStatus();
                
                // æ¥å£è¯·æ±‚æˆåŠŸï¼ˆçŠ¶æ€ç 200ï¼‰
                if (data.status === 200) {
                    // æ•´ç†æ­Œæ›²ä¿¡æ¯
                    const songInfo = {
                        id: id,
                        name: data.name || 'æœªçŸ¥æ­Œæ›²',
                        ar_name: data.ar_name || data.artist || 'æœªçŸ¥æ­Œæ‰‹',
                        al_name: data.al_name || data.album || 'æœªçŸ¥ä¸“è¾‘',
                        pic: data.pic || data.coverImgUrl || '',
                        // è½¬æ¢éŸ³è´¨å€¼ä¸ºä¸­æ–‡æ˜¾ç¤º
                        level: quality === 'standard' ? 'æ ‡å‡†' : 
                               quality === 'higher' ? 'è¾ƒé«˜' : 
                               quality === 'exhigh' ? 'æé«˜' : 
                               quality === 'lossless' ? 'æ— æŸ' : 'Hi-Res',
                        size: data.size ? window.myMusicPage.formatFileSize(data.size) : 'æœªçŸ¥',
                        url: data.url // ä¸‹è½½é“¾æ¥
                    };
                    
                    // ä¿å­˜å½“å‰æ­Œæ›²åˆ°æ’­æ”¾åˆ—è¡¨ï¼ˆç”¨äºæ’­æ”¾åŠŸèƒ½ï¼‰
                    window.myMusicPage.currentTracks = [{
                        id: songInfo.id, 
                        name: songInfo.name, 
                        ar: [{name: songInfo.ar_name}], 
                        al: {name: songInfo.al_name, picUrl: songInfo.pic}
                    }];
                    
                    // æ¸²æŸ“æ­Œæ›²ç»“æœåˆ°é¡µé¢
                    window.myMusicPage.renderSongResult(songInfo);
                } else {
                    // jxæ¥å£å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨songæ¥å£
                    console.warn('jxæ¥å£å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨songæ¥å£');
                    const songResponse = await fetch(`/music/song/${id}`);
                    const songData = await songResponse.json();
                    
                    // å¤‡ç”¨æ¥å£è¯·æ±‚æˆåŠŸ
                    if (songData.code === 200 && songData.songs && songData.songs.length > 0) {
                        const song = songData.songs[0];
                        const songInfo = {
                            id: song.id,
                            name: song.name,
                            ar_name: song.artists ? song.artists.map(a => a.name).join('/') : 'æœªçŸ¥æ­Œæ‰‹',
                            al_name: song.album ? song.album.name : 'æœªçŸ¥ä¸“è¾‘',
                            pic: song.album ? song.album.picUrl : '',
                            level: 'æ ‡å‡†',
                            size: 'æœªçŸ¥'
                        };
                        
                        // ä¿å­˜åˆ°æ’­æ”¾åˆ—è¡¨
                        window.myMusicPage.currentTracks = [{
                            id: songInfo.id, 
                            name: songInfo.name, 
                            ar: [{name: songInfo.ar_name}], 
                            al: {name: songInfo.al_name, picUrl: songInfo.pic}
                        }];
                        
                        // æ¸²æŸ“ç»“æœ
                        window.myMusicPage.renderSongResult(songInfo);
                    } else {
                        throw new Error('æ­Œæ›²è§£æå¤±è´¥');
                    }
                }
            } catch (error) {
                // è§£æå¤±è´¥å¤„ç†
                console.error('è§£ææ­Œæ›²å¤±è´¥:', error);
                window.myMusicPage.hideStatus();
                window.myMusicPage.showError('æ— æ³•è·å–æ­Œæ›²ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®');
            }
        },
        
        /**
         * è§£ææ­Œå•ï¼šè°ƒç”¨æ¥å£è·å–æ­Œå•ä¿¡æ¯å¹¶æ¸²æŸ“ç»“æœ
         * @param {string} id - æ­Œå•ID
         */
        parsePlaylist: async function(id) {
            try {
                // æ˜¾ç¤ºçŠ¶æ€æç¤º
                window.myMusicPage.showStatus('æ­£åœ¨è·å–æ­Œå•ä¿¡æ¯...');
                
                // æå–çº¯æ•°å­—IDï¼ˆå¤„ç†å¯èƒ½åŒ…å«é“¾æ¥çš„æƒ…å†µï¼‰
                let playlistId = id;
                if (typeof id === 'string' && id.includes('music.163.com')) {
                    const idMatch = id.match(/id=(\d+)|\/(\d+)/);
                    if (idMatch) playlistId = idMatch[1] || idMatch[2];
                }
                
                // éªŒè¯æ­Œå•IDæ ¼å¼ï¼ˆçº¯æ•°å­—ï¼‰
                if (!/^\d+$/.test(playlistId)) {
                    window.myMusicPage.hideStatus();
                    window.myMusicPage.showError('æ— æ•ˆçš„æ­Œå•IDæ ¼å¼ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„æ­Œå•é“¾æ¥æˆ–ID');
                    return;
                }
                
                // è°ƒç”¨æ¥å£è·å–æ­Œå•ä¿¡æ¯
                const response = await fetch(`/music/playlist/${playlistId}`);
                const data = await response.json();
                
                // éšè—çŠ¶æ€æç¤º
                window.myMusicPage.hideStatus();
                
                // æ¥å£è¯·æ±‚æˆåŠŸï¼ˆçŠ¶æ€ç 200ï¼‰
                if (data.code === 200) {
                    // å¤„ç†ä¸åŒæ•°æ®ç»“æ„ï¼ˆå…¼å®¹ä¸åŒæ¥å£è¿”å›æ ¼å¼ï¼‰
                    let playlist, tracks;
                    if (data.result && data.result.tracks) {
                        playlist = data.result;
                        tracks = playlist.tracks;
                    } else if (data.playlist && data.playlist.tracks) {
                        playlist = data.playlist;
                        tracks = playlist.tracks;
                    } else if (data.tracks) {
                        tracks = data.tracks;
                        playlist = {name: 'æ­Œå•', trackCount: tracks.length, creator: {nickname: 'æœªçŸ¥'}, coverImgUrl: ''};
                    } else {
                        window.myMusicPage.showError('æ­Œå•æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }
                    
                    // ä¿å­˜æ­Œå•æ­Œæ›²åˆ—è¡¨ï¼ˆç”¨äºæ’­æ”¾ï¼‰
                    window.myMusicPage.currentTracks = tracks;
                    // æ¸²æŸ“æ­Œå•ç»“æœåˆ°é¡µé¢
                    window.myMusicPage.renderPlaylistResult(playlist);
                } else {
                    window.myMusicPage.showError('æ— æ³•è·å–æ­Œå•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                // è§£æå¤±è´¥å¤„ç†
                console.error('è§£ææ­Œå•å¤±è´¥:', error);
                window.myMusicPage.hideStatus();
                window.myMusicPage.showError('æ— æ³•è·å–æ­Œå•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®');
            }
        },
        
        /**
         * HTMLè½¬ä¹‰å‡½æ•°ï¼šé˜²æ­¢XSSæ”»å‡»ï¼Œå®‰å…¨æ¸²æŸ“æ–‡æœ¬
         * @param {string} text - éœ€è¦è½¬ä¹‰çš„æ–‡æœ¬
         * @returns {string} - è½¬ä¹‰åçš„æ–‡æœ¬
         */
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        /**
         * æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°ï¼šå°†å­—èŠ‚æ•°è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼ˆB/KB/MB/GBï¼‰
         * @param {number} bytes - å­—èŠ‚æ•°
         * @returns {string} - æ ¼å¼åŒ–åçš„æ–‡ä»¶å¤§å°
         */
        formatFileSize: function(bytes) {
            if (typeof bytes !== 'number' || bytes < 0) return 'æœªçŸ¥';
            if (bytes === 0) return '0 B';
            
            const k = 1024; // è¿›åˆ¶ï¼š1024
            const sizes = ['B', 'KB', 'MB', 'GB'];
            // è®¡ç®—å•ä½ç´¢å¼•
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            // ä¿ç•™2ä½å°æ•°å¹¶æ‹¼æ¥å•ä½
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        /**
         * æ¸²æŸ“æ­Œæ›²ç»“æœï¼šå°†æ­Œæ›²ä¿¡æ¯æ˜¾ç¤ºåˆ°é¡µé¢
         * @param {object} data - æ­Œæ›²ä¿¡æ¯å¯¹è±¡
         */
        renderSongResult: function(data) {
            const container = document.getElementById('resultContainer');
            
            // æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šè°ƒç”¨æ’­æ”¾å‡½æ•°
            const playBtnClick = `parseAndPlaySong('${data.id}', '${window.myMusicPage.escapeHtml(data.name)}', '${window.myMusicPage.escapeHtml(data.ar_name)}', '${window.myMusicPage.escapeHtml(data.pic || '')}')`;
            // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šæ‰“å¼€ä¸‹è½½é“¾æ¥ï¼ˆæ— é“¾æ¥æ—¶æç¤ºï¼‰
            const downloadBtnClick = data.url 
                ? `window.open('${data.url}', '_blank')` 
                : 'window.myMusicPage.showStatus(\'æš‚æ— ä¸‹è½½é“¾æ¥\')';
            
            // å°é¢HTMLï¼ˆæœ‰å›¾ç‰‡æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ— å›¾ç‰‡æ˜¾ç¤ºå ä½ç¬¦ï¼‰
            const coverHtml = data.pic 
                ? `<img src="${data.pic}" alt="${window.myMusicPage.escapeHtml(data.name)}\å°é¢" onerror="this.onerror=null; const div=document.createElement('div'); div.className='cover-placeholder'; div.textContent='ğŸµ'; this.closest('.cover-img').appendChild(div); this.remove();">`
                : '<div class="cover-placeholder">ğŸµ</div>';
            
            // æ‹¼æ¥HTMLç»“æ„ï¼Œæ¸²æŸ“åˆ°é¡µé¢
            container.innerHTML = `
                <div class="song-result">
                    <div class="song-content">
                        <!-- æ­Œæ›²å°é¢ -->
                        <div class="song-cover">
                            <div class="cover-img">
                                ${coverHtml}
                            </div>
                        </div>
                        <!-- æ­Œæ›²ä¿¡æ¯ -->
                        <div class="song-info">
                            <h2 class="song-title">${window.myMusicPage.escapeHtml(data.name)}</h2>
                            <p class="song-artist">${window.myMusicPage.escapeHtml(data.ar_name)}</p>
                            <p class="song-album">${window.myMusicPage.escapeHtml(data.al_name)}</p>
                            <!-- æ­Œæ›²å…ƒä¿¡æ¯ï¼ˆéŸ³è´¨ã€å¤§å°ï¼‰ -->
                            <div class="song-meta">
                                <span class="meta-item">
                                    <i class="icon">ğŸµ</i>
                                    <span>éŸ³è´¨ï¼š${data.level}</span>
                                </span>
                                <span class="meta-item">
                                    <i class="icon">ğŸ“</i>
                                    <span>å¤§å°ï¼š${data.size}</span>
                                </span>
                            </div>
                        </div>
                        <!-- æ“ä½œæŒ‰é’®ï¼ˆæ’­æ”¾ã€ä¸‹è½½ï¼‰ -->
                        <div class="song-actions">
                            <button class="play-button" onclick="event.preventDefault(); ${playBtnClick}; return false;">
                                <i class="icon">â–¶</i>
                                <span>æ’­æ”¾</span>
                            </button>
                            <button class="download-button" onclick="event.preventDefault(); ${downloadBtnClick}; return false;">
                                <i class="icon">â¬‡</i>
                                <span>ä¸‹è½½</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },
        
        /**
         * æ¸²æŸ“æ­Œå•ç»“æœï¼šå°†æ­Œå•ä¿¡æ¯å’Œæ­Œæ›²åˆ—è¡¨æ˜¾ç¤ºåˆ°é¡µé¢
         * @param {object} playlist - æ­Œå•ä¿¡æ¯å¯¹è±¡
         */
        renderPlaylistResult: function(playlist) {
            const container = document.getElementById('resultContainer');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // åˆ›å»ºæ­Œå•ç»“æœå®¹å™¨
            const playlistResultDiv = document.createElement('div');
            playlistResultDiv.className = 'playlist-result';
            
            // åˆ›å»ºæ­Œå•å¤´éƒ¨
            const playlistHeader = document.createElement('div');
            playlistHeader.className = 'wy-playlist-header';
            playlistHeader.style.display = 'flex';
            playlistHeader.style.gap = '20px';
            playlistHeader.style.marginBottom = '20px';
            
            // åˆ›å»ºå°é¢å®¹å™¨
            const playlistCover = document.createElement('div');
            playlistCover.className = 'playlist-cover';
            playlistCover.style.width = '180px';
            playlistCover.style.height = '180px';
            playlistCover.style.borderRadius = '12px';
            playlistCover.style.overflow = 'hidden';
            playlistCover.style.backgroundColor = '#f5f5f5';
            playlistCover.style.display = 'flex';
            playlistCover.style.alignItems = 'center';
            playlistCover.style.justifyContent = 'center';
            
            // æ·»åŠ å°é¢å›¾ç‰‡æˆ–å ä½ç¬¦
            if (playlist.coverImgUrl) {
                const img = document.createElement('img');
                img.src = playlist.coverImgUrl;
                img.alt = playlist.name + 'å°é¢';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                // æ·»åŠ é”™è¯¯å¤„ç†
                img.onerror = function() {
                    this.onerror = null;
                    playlistCover.innerHTML = '';
                    const placeholder = document.createElement('div');
                    placeholder.className = 'cover-placeholder';
                    placeholder.textContent = 'ğŸµ';
                    placeholder.style.fontSize = '48px';
                    playlistCover.appendChild(placeholder);
                };
                
                playlistCover.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'cover-placeholder';
                placeholder.textContent = 'ğŸµ';
                placeholder.style.fontSize = '48px';
                playlistCover.appendChild(placeholder);
            }
            
            // åˆ›å»ºæ­Œå•ä¿¡æ¯å®¹å™¨
            const playlistInfo = document.createElement('div');
            playlistInfo.className = 'playlist-info';
            playlistInfo.style.flex = '1';
            playlistInfo.style.display = 'block';
            
            // æ·»åŠ æ­Œå•æ ‡é¢˜
            const title = document.createElement('h2');
            title.textContent = playlist.name;
            title.style.margin = '0 0 10px 0';
            title.style.fontSize = '1.8rem';
            playlistInfo.appendChild(title);
            
            // æ·»åŠ åˆ›å»ºè€…ä¿¡æ¯
            const creator = document.createElement('p');
            creator.textContent = 'åˆ›å»ºè€…: ' + (playlist.creator?.nickname || 'æœªçŸ¥');
            creator.style.margin = '0 0 8px 0';
            creator.style.color = '#666';
            playlistInfo.appendChild(creator);
            
            // æ·»åŠ æ­Œæ›²æ•°é‡
            const count = document.createElement('p');
            count.textContent = 'å…± ' + (playlist.trackCount || playlist.tracks?.length || 0) + 'é¦–';
            count.style.margin = '0 0 15px 0';
            count.style.color = '#666';
            playlistInfo.appendChild(count);
            
            // æ·»åŠ æ’­æ”¾å…¨éƒ¨æŒ‰é’®
            const playAllBtn = document.createElement('button');
            playAllBtn.className = 'play-all-button';
            playAllBtn.style.padding = '10px 20px';
            playAllBtn.style.backgroundColor = '#6c4ab6';
            playAllBtn.style.color = 'white';
            playAllBtn.style.border = 'none';
            playAllBtn.style.borderRadius = '8px';
            playAllBtn.style.cursor = 'pointer';
            playAllBtn.style.display = 'flex';
            playAllBtn.style.alignItems = 'center';
            playAllBtn.style.gap = '8px';
            
            const playIcon = document.createElement('i');
            playIcon.className = 'icon';
            playIcon.textContent = 'â–¶';
            playAllBtn.appendChild(playIcon);
            
            const btnText = document.createElement('span');
            btnText.textContent = 'æ’­æ”¾å…¨éƒ¨';
            playAllBtn.appendChild(btnText);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            playAllBtn.addEventListener('click', function(event) {
                event.preventDefault();
                window.myMusicPage.playPlaylist(event);
            });
            
            playlistInfo.appendChild(playAllBtn);
            
            // ç»„è£…å¤´éƒ¨
            playlistHeader.appendChild(playlistCover);
            playlistHeader.appendChild(playlistInfo);
            playlistResultDiv.appendChild(playlistHeader);
            
            // åˆ›å»ºæ­Œæ›²åˆ—è¡¨å®¹å™¨
            const tracksContainer = document.createElement('div');
            tracksContainer.className = 'tracks-container';
            tracksContainer.style.overflowX = 'auto';
            
            // åˆ›å»ºè¡¨æ ¼
            const table = document.createElement('table');
            table.className = 'tracks-table';
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // è¡¨å¤´å•å…ƒæ ¼
            const headers = [
                { className: 'col-index', text: 'åºå·', style: 'width: 60px; text-align: center; color: #666;' },
                { className: 'col-title', text: 'æ­Œæ›²å', style: 'color: #333;' },
                { className: 'col-artist', text: 'æ­Œæ‰‹', style: 'color: #666;' },
                { className: 'col-album', text: 'ä¸“è¾‘', style: 'color: #666;' },
                { className: 'col-action', text: 'æ“ä½œ', style: 'width: 80px;' }
            ];
            
            headers.forEach(headerData => {
                const th = document.createElement('th');
                th.className = headerData.className;
                th.textContent = headerData.text;
                th.style.padding = '12px';
                th.style.textAlign = 'left';
                th.style.borderBottom = '1px solid #eee';
                th.style.backgroundColor = '#6c4ab6'; // ä¿®æ”¹ä¸ºç´«è‰²èƒŒæ™¯
                th.style.color = '#ffffff'; // è®¾ç½®æ–‡å­—é¢œè‰²ä¸ºç™½è‰²
                th.style.fontWeight = '500';
                th.style.cssText += headerData.style;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºè¡¨ä½“
            const tbody = document.createElement('tbody');
            
            // éå†æ­Œæ›²åˆ—è¡¨
            if (playlist.tracks && Array.isArray(playlist.tracks)) {
                playlist.tracks.forEach((track, index) => {
                    // æå–æ­Œæ›²ä¿¡æ¯
                    const trackName = track.name || 'æœªçŸ¥æ­Œæ›²';
                    const trackArtist = track.artists 
                        ? track.artists.map(a => a.name || a.ar).join(', ') 
                        : (track.ar ? track.ar.map(a => a.name || a.ar).join(', ') : 'æœªçŸ¥æ­Œæ‰‹');
                    const trackAlbum = track.album ? track.album.name : 'æœªçŸ¥ä¸“è¾‘';
                    const trackId = track.id;
                    const coverUrl = track.album ? track.album.picUrl : '';
                    
                    // åˆ›å»ºè¡Œ
                    const row = document.createElement('tr');
                    row.style.transition = 'background-color 0.2s';
                    row.onmouseenter = function() {
                        this.style.backgroundColor = 'rgba(108, 74, 182, 0.05)';
                    };
                    row.onmouseleave = function() {
                        this.style.backgroundColor = 'transparent';
                    };
                    
                    // åˆ›å»ºå•å…ƒæ ¼ - åºå·
                    const indexCell = document.createElement('td');
                    indexCell.className = 'col-index';
                    indexCell.textContent = index + 1;
                    indexCell.style.padding = '12px';
                    indexCell.style.textAlign = 'center';
                    indexCell.style.borderBottom = '1px solid #eee';
                    indexCell.style.color = '#666';
                    row.appendChild(indexCell);
                    
                    // åˆ›å»ºå•å…ƒæ ¼ - æ­Œæ›²å
                    const titleCell = document.createElement('td');
                    titleCell.className = 'col-title';
                    titleCell.textContent = trackName;
                    titleCell.style.padding = '12px';
                    titleCell.style.borderBottom = '1px solid #eee';
                    titleCell.style.color = '#333';
                    row.appendChild(titleCell);
                    
                    // åˆ›å»ºå•å…ƒæ ¼ - æ­Œæ‰‹
                    const artistCell = document.createElement('td');
                    artistCell.className = 'col-artist';
                    artistCell.textContent = trackArtist;
                    artistCell.style.padding = '12px';
                    artistCell.style.borderBottom = '1px solid #eee';
                    artistCell.style.color = '#666';
                    row.appendChild(artistCell);
                    
                    // åˆ›å»ºå•å…ƒæ ¼ - ä¸“è¾‘
                    const albumCell = document.createElement('td');
                    albumCell.className = 'col-album';
                    albumCell.textContent = trackAlbum;
                    albumCell.style.padding = '12px';
                    albumCell.style.borderBottom = '1px solid #eee';
                    albumCell.style.color = '#666';
                    row.appendChild(albumCell);
                    
                    // åˆ›å»ºå•å…ƒæ ¼ - æ“ä½œæŒ‰é’®
                    const actionCell = document.createElement('td');
                    actionCell.className = 'col-action';
                    actionCell.style.padding = '12px';
                    actionCell.style.borderBottom = '1px solid #eee';
                    
                    // åˆ›å»ºæ’­æ”¾æŒ‰é’®
                    const playBtn = document.createElement('button');
                    playBtn.className = 'track-play-button';
                    playBtn.style.background = 'none';
                    playBtn.style.border = 'none';
                    playBtn.style.color = '#6c4ab6';
                    playBtn.style.cursor = 'pointer';
                    playBtn.style.fontSize = '1.2rem';
                    playBtn.style.width = '36px';
                    playBtn.style.height = '36px';
                    playBtn.style.borderRadius = '50%';
                    playBtn.style.display = 'flex';
                    playBtn.style.alignItems = 'center';
                    playBtn.style.justifyContent = 'center';
                    playBtn.style.transition = 'background-color 0.2s';
                    
                    playBtn.onmouseenter = function() {
                        this.style.backgroundColor = 'rgba(108, 74, 182, 0.2)';
                    };
                    playBtn.onmouseleave = function() {
                        this.style.backgroundColor = 'transparent';
                    };
                    
                    // æ·»åŠ æ’­æ”¾å›¾æ ‡
                    const icon = document.createElement('i');
                    icon.className = 'icon';
                    icon.textContent = 'â–¶';
                    playBtn.appendChild(icon);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    playBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        window.myMusicPage.parseAndPlaySong(trackId, trackName, trackArtist, coverUrl);
                    });
                    
                    actionCell.appendChild(playBtn);
                    row.appendChild(actionCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            table.appendChild(tbody);
            tracksContainer.appendChild(table);
            playlistResultDiv.appendChild(tracksContainer);
            
            // å°†æ•´ä¸ªç»“æœæ·»åŠ åˆ°å®¹å™¨
            container.appendChild(playlistResultDiv);
        },
        
        /**
         * æ’­æ”¾æ­Œå•å…¨éƒ¨æ­Œæ›²ï¼šè°ƒç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ•´ä¸ªæ­Œå•
         * @param {Event} event - ç‚¹å‡»äº‹ä»¶å¯¹è±¡
         */
        playPlaylist: function(event) {
            event && event.preventDefault();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯æ’­æ”¾çš„æ­Œæ›²
            if (!window.myMusicPage.currentTracks || window.myMusicPage.currentTracks.length === 0) {
                window.myMusicPage.showError('æš‚æ— æ­Œæ›²å¯æ’­æ”¾');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åº•éƒ¨æ’­æ”¾å™¨å¯ç”¨
            if (window.playTrackFromPlaylist) {
                // æ ‡å‡†åŒ–æ­Œæ›²å¯¹è±¡æ ¼å¼ï¼ˆé€‚é…æ’­æ”¾å™¨è¦æ±‚ï¼‰
                const standardizedTracks = window.myMusicPage.currentTracks.map(track => ({
                    id: track.id,
                    name: track.name || 'æœªçŸ¥æ­Œæ›²',
                    artists: track.artists || track.ar || [],
                    album: track.album || { picUrl: '' }
                }));
                
                try {
                    // è°ƒç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ•´ä¸ªæ­Œå•ï¼ˆä»ç¬¬0é¦–å¼€å§‹ï¼‰
                    window.playTrackFromPlaylist(standardizedTracks, 0);
                    console.log('æˆåŠŸè°ƒç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ­Œå•');
                } catch (error) {
                    console.error('åº•éƒ¨æ’­æ”¾å™¨è°ƒç”¨å¤±è´¥:', error);
                    window.myMusicPage.showError('æ’­æ”¾å¤±è´¥: åº•éƒ¨æ’­æ”¾å™¨å¼‚å¸¸');
                }
            } else {
                window.myMusicPage.showError('æ’­æ”¾å™¨åŠŸèƒ½ä¸å¯ç”¨');
            }
        },
        
        /**
         * è§£æå¹¶æ’­æ”¾æ­Œæ›²ï¼šä½¿ç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾å•é¦–æ­Œæ›²
         * @param {string} id - æ­Œæ›²ID
         * @param {string} name - æ­Œæ›²åç§°
         * @param {string} artist - æ­Œæ‰‹åç§°
         * @param {string} cover - å°é¢å›¾ç‰‡URL
         * @returns {boolean} - æ’­æ”¾æ“ä½œæ˜¯å¦æˆåŠŸ
         */
        parseAndPlaySong: function(id, name, artist, cover) {
            console.log('å°è¯•æ’­æ”¾æ­Œæ›²:', { id, name, artist, cover });
            
            // éªŒè¯IDæœ‰æ•ˆæ€§
            if (!id || (typeof id !== 'string' && typeof id !== 'number')) {
                console.error('æ— æ•ˆçš„æ­Œæ›²ID:', id);
                window.myMusicPage.showError('æ— æ•ˆçš„æ­Œæ›²ID');
                return false;
            }
            
            // æ¸…ç†IDï¼ˆåªä¿ç•™æ•°å­—ï¼‰
            const cleanId = String(id).replace(/[^0-9]/g, '');
            
            // éªŒè¯IDæ ¼å¼ï¼ˆè‡³å°‘5ä½æ•°å­—ï¼‰
            if (!/^\d{5,}$/.test(cleanId)) {
                console.error('IDæ ¼å¼æ— æ•ˆ:', cleanId);
                window.myMusicPage.showError('æ­Œæ›²IDæ ¼å¼æ— æ•ˆï¼Œè¯·è¾“å…¥è‡³å°‘5ä½æ•°å­—');
                return false;
            }
            
            // ä¼˜å…ˆä½¿ç”¨å…¨å±€æ’­æ”¾å‡½æ•°ï¼ˆåº•éƒ¨æ’­æ”¾å™¨ï¼‰
            if (window.playTrackFromPlaylist) {
                console.log('è°ƒç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ­Œæ›²');
                
                // å‡†å¤‡æ ‡å‡†åŒ–çš„æ­Œæ›²å¯¹è±¡ï¼ˆé€‚é…æ’­æ”¾å™¨ï¼‰
                const singleTrack = {
                    id: cleanId,
                    name: name || 'æœªçŸ¥æ­Œæ›²',
                    artists: artist ? [{ name: artist }] : [],
                    album: { 
                        picUrl: cover || '',
                        name: 'æœªçŸ¥ä¸“è¾‘'
                    },
                    dt: 0 // æ—¶é•¿ï¼ˆé»˜è®¤0ï¼‰
                };
                
                try {
                    // è°ƒç”¨åº•éƒ¨æ’­æ”¾å™¨æ’­æ”¾æ­Œæ›²
                    window.playTrackFromPlaylist([singleTrack], 0);
                    // æ˜¾ç¤ºæ’­æ”¾çŠ¶æ€æç¤º
                    window.myMusicPage.showStatus(`æ­£åœ¨æ’­æ”¾: ${name || 'æœªçŸ¥æ­Œæ›²'} - ${artist || 'æœªçŸ¥æ­Œæ‰‹'}`);
                    return true;
                } catch (error) {
                    console.error('åº•éƒ¨æ’­æ”¾å™¨è°ƒç”¨å¤±è´¥:', error);
                    window.myMusicPage.showError('æ’­æ”¾å¤±è´¥: åº•éƒ¨æ’­æ”¾å™¨å¼‚å¸¸');
                    return false;
                }
            } else {
                console.error('æœªæ‰¾åˆ°åº•éƒ¨æ’­æ”¾å™¨');
                window.myMusicPage.showError('æ’­æ”¾å™¨åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return false;
            }
        },
        
        /**
         * æ˜¾ç¤ºæ’­æ”¾çŠ¶æ€æç¤º
         * @param {string} message - æç¤ºä¿¡æ¯
         */
        showStatus: function(message) {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºçŠ¶æ€å®¹å™¨
            let statusContainer = document.getElementById('playStatus');
            if (!statusContainer) {
                statusContainer = document.createElement('div');
                statusContainer.id = 'playStatus';
                statusContainer.className = 'play-status';
                document.body.appendChild(statusContainer);
            }
            
            // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            statusContainer.innerHTML = `<div class="playing">${message}</div>`;
            statusContainer.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusContainer.style.display = 'none';
            }, 5000);
        },
        
        /**
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         */
        showLoading: function() {
            const resultContainer = document.getElementById('resultContainer');
            const statusContainer = document.getElementById('statusContainer');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            
            // æ¸…ç©ºç»“æœå®¹å™¨ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultContainer.innerHTML = '';
            statusContainer.style.display = 'block';
            loadingState.style.display = 'block';
            errorState.style.display = 'none';
        },
        
        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤º
         * @param {string} message - é”™è¯¯ä¿¡æ¯
         */
        showError: function(message) {
            const statusContainer = document.getElementById('statusContainer');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            statusContainer.style.display = 'block';
            loadingState.style.display = 'none';
            errorState.textContent = message;
            errorState.style.display = 'block';
        },
        
        /**
         * éšè—çŠ¶æ€æç¤ºï¼ˆåŠ è½½/é”™è¯¯ï¼‰
         */
        hideStatus: function() {
            const statusContainer = document.getElementById('statusContainer');
            statusContainer.style.display = 'none';
        }
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    (function() {
        // é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–
        if (window.myMusicPage && window.myMusicPage.initialized) return;
        
        // åˆå§‹åŒ–å‡½æ•°
        function initMyMusicPage() {
            // ç¡®ä¿DOMå®Œå…¨åŠ è½½
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMyMusicPage);
            } else {
                // æ‰§è¡Œåˆå§‹åŒ–
                window.myMusicPage.init();
                window.myMusicPage.initialized = true;
                console.log('ç½‘æ˜“äº‘éŸ³ä¹è§£æé¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        initMyMusicPage();
    })();
    
    // ä¸ºäº†è§£æè¡¨æ ¼ä¸­çš„æ­Œæ›²ï¼ˆä¿æŒå‘åå…¼å®¹ä½†ä½¿ç”¨å®Œæ•´å‘½åç©ºé—´ï¼‰
    if (typeof window.parseAndPlaySong === 'undefined') {
        window.parseAndPlaySong = function(id, name, artist, cover) {
            return window.myMusicPage.parseAndPlaySong(id, name, artist, cover);
        };
    }
</script>