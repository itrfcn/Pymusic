<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音悦台 - 发现好音乐</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <icon rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" sizes="32x32">
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar sidebar-closed">
            <div class="logo">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="音悦台">
                <span>音悦台</span>
            </div>
            <nav class="menu">
                <h2 class="menu-title">菜单</h2>
                <ul>
                    <li {% if page == 'discover' or not page %}class="active"{% endif %}><a class="nav-link" href="/discover"><i
                            class="fa-solid fa-house"></i><span>发现音乐</span></a></li>
                    <li {% if page == 'rank' %}class="active"{% endif %}><a class="nav-link" href="/rank"><i class="fa-solid fa-chart-line"></i><span>排行榜</span></a></li>
                    {% if session.get('username') %}
                    <li {% if page == 'history' %}class="active"{% endif %}><a class="nav-link" href="/history"><i
                            class="fa-solid fa-clock-rotate-left"></i><span>播放历史</span></a></li>
                    {% endif %}
                    <li {% if page == 'doc-163' %}class="active"{% endif %}><a class="nav-link" href="/doc-163"><i
                            class="fa-solid fa-compact-disc"></i><span>音乐解析</span></a></li>
                    {% if session.get('username') %}
                    <li {% if page == 'netease_playlists' %}class="active"{% endif %}><a class="nav-link" href="/netease_playlists"><i
                            class="fa-solid fa-music"></i><span>网易云歌单</span></a></li>
                    {% endif %}
                    <li {% if page == 'about' %}class="active"{% endif %}><a class="nav-link" href="/about"><i
                            class="fa-solid fa-circle-info"></i><span>关于我们</span></a></li>
                </ul>
            </nav>
            <nav class="menu">
                <h2 class="menu-title">歌单</h2>
                {% if session.get('username') %}
                <button id="create-playlist-btn" class="btn-create-playlist">
                    <i class="fa-solid fa-plus"></i> 创建歌单
                </button>
                <ul id="user-playlists">
                    <!-- 歌单将通过JavaScript动态加载 -->
                    <li class="loading-playlists">加载中...</li>
                </ul>
                
                {% else %}
                <ul>
                    <li class="no-login-tip">登录后可使用歌单功能</li>
                </ul>
                {% endif %}
            </nav>
        </aside>


        <!-- Main View -->
        <main class="main-view">
            <!-- Header -->
            <header class="main-header">
                <button class="mobile-menu-btn" aria-label="打开菜单">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="搜索">
                </div>
                <div class="user-profile">
                    {% if session.get('username') %}
                        <span class="user-name"><a href="javascript:void(0);" onclick="openProfileModal();">{{ session.get('username') }}</a></span>
                        
                        <script>
                        function openProfileModal() {
                            // 创建模态对话框容器
                            var modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'white';
                            modal.style.zIndex = '9999';
                            modal.style.overflow = 'auto';
                            
                            // 创建关闭按钮
                            var closeBtn = document.createElement('button');
                            closeBtn.innerHTML = '×';
                            closeBtn.style.position = 'absolute';
                            closeBtn.style.top = '15px';
                            closeBtn.style.right = '15px';
                            closeBtn.style.fontSize = '24px';
                            closeBtn.style.width = '36px';
                            closeBtn.style.height = '36px';
                            closeBtn.style.borderRadius = '50%';
                            closeBtn.style.background = 'rgba(0,0,0,0.1)';
                            closeBtn.style.color = '#333';
                            closeBtn.style.border = '1px solid rgba(0,0,0,0.1)';
                            closeBtn.style.cursor = 'pointer';
                            closeBtn.style.display = 'flex';
                            closeBtn.style.alignItems = 'center';
                            closeBtn.style.justifyContent = 'center';
                            closeBtn.style.fontWeight = 'bold';
                            closeBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.12)';
                            closeBtn.style.transition = 'all 0.2s ease';
                            closeBtn.onmouseover = function() {
                                closeBtn.style.background = '#f5f5f5';
                                closeBtn.style.transform = 'translateY(-1px)';
                                closeBtn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.15)';
                            };
                            closeBtn.onmouseout = function() {
                                closeBtn.style.background = 'rgba(0,0,0,0.1)';
                                closeBtn.style.transform = 'translateY(0)';
                                closeBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.12)';
                            };
                            closeBtn.onclick = function() {
                                document.body.removeChild(modal);
                            };
                            modal.appendChild(closeBtn);
                            
                            // 创建iframe显示编辑页面
                            var iframe = document.createElement('iframe');
                            iframe.src = '/user/edit_profile';
                            iframe.style.width = '100%';
                            iframe.style.height = '100%';
                            iframe.style.border = 'none';
                            modal.appendChild(iframe);
                            
                            // 添加到页面
                            document.body.appendChild(modal);
                        }
                        </script>
                        <!-- 待优化 -->
                        <a href="/user/logout" class="btn btn-logout">退出</a>
                    {% else %}
                        <a href="/login" class="btn btn-login">登录</a>
                        <a href="/register" class="btn btn-register">注册</a>
                    {% endif %}
                </div>
            </header>

            <!-- Main Content -->
            <div class="main-content">
                {% include 'partials/' ~ (page if page else 'discover') ~ '.html' %}
            </div>
        </main>

        <!-- Music Player -->
        <footer class="music-player">
            <!-- 歌曲信息区域在左侧 -->
            <div class="player-row">
                <div class="song-info">
                    <img src="/static/img/logo.png" alt="歌曲封面">
                    <div class="song-details">
                        <h3>暂未选中歌曲</h3>
                        <p>请选择歌曲</p>
                    </div>
                </div>
            </div>
            
            <!-- 播放控制区域在中间 -->
            <div class="player-controls">
                <div class="control-buttons">
                    <button class="btn"><i class="fa-solid fa-backward-step"></i></button>
                    <button class="btn play-pause-btn"><i class="fa-solid fa-play"></i></button>
                    <button class="btn"><i class="fa-solid fa-forward-step"></i></button>
                </div>
                <div class="progress-bar">
                    <span class="time">0:00</span>
                    <div class="progress-container">
                        <div class="progress"></div>
                    </div>
                    <span class="time">0:00</span>
                </div>
            </div>
            
            <!-- 播放器选项区域在右侧 -->
            <div class="player-options">
                <button class="btn btn-lyrics-toggle"><i class="fa-solid fa-microphone-lines"></i></button>
                <button class="btn btn-add-to-playlist" id="add-to-playlist-btn"><i class="fa-solid fa-heart"></i></button>
                <div class="volume-control">
                    <button class="btn"><i class="fa-solid fa-volume-high"></i></button>
                    <div class="volume-slider-container">
                        <div class="volume-slider"></div>
                    </div>
                </div>
                <button class="btn"><i class="fa-solid fa-list"></i></button>
            </div>
            
            <style>
                /* 默认电脑模式样式 - 实现选项div在控制div右侧 */
                .music-player {
                    padding: 8px 16px;
                    min-height: 80px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    background: linear-gradient(135deg, rgba(22, 22, 22, 0.95), rgba(40, 40, 40, 0.95));
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    z-index: 1000;
                    backdrop-filter: blur(15px);
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.3);
                    transition: all 0.3s ease;
                }
                
                /* 歌曲信息区域在左侧 */
                .player-row {
                    display: flex;
                    align-items: center;
                    width: 300px;
                    flex-shrink: 0;
                }
                
                .song-info {
                    display: flex;
                    align-items: center;
                    flex: 1;
                }
                
                .song-info img {
                    width: 48px;
                    height: 48px;
                    border-radius: 6px;
                    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
                    flex-shrink: 0;
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                .song-info img:hover {
                    transform: scale(1.05);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                }
                
                .song-details {
                    margin-left: 12px;
                    flex: 1;
                    min-width: 0;
                }
                
                .song-details h3 {
                    font-size: 14px;
                    margin: 0 0 2px 0;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    font-weight: 600;
                    transition: color 0.3s ease;
                }
                .song-details h3:hover {
                    color: #1890ff;
                }
                
                .song-details p {
                    font-size: 12px;
                    margin: 0;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    opacity: 0.7;
                    transition: opacity 0.3s ease;
                }
                .song-details p:hover {
                    opacity: 0.9;
                }
                
                /* 播放控制区域在中间 */
                .player-controls {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-width: 400px;
                    margin: 0 20px;
                }
                
                .control-buttons {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-bottom: 8px;
                }
                
                .control-buttons .btn {
                    background: none;
                    border: none;
                    color: #ddd;
                    cursor: pointer;
                    font-size: 16px;
                    margin: 0 8px;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: all 0.3s ease;
                    position: relative;
                }
                
                .control-buttons .btn:hover {
                    color: white;
                    background-color: rgba(255, 255, 255, 0.15);
                    transform: scale(1.1);
                }
                
                .control-buttons .btn-play {
                    font-size: 24px;
                    width: 48px;
                    height: 48px;
                    background: linear-gradient(135deg, #1890ff, #40a9ff);
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.4);
                    position: relative;
                    overflow: hidden;
                }
                .control-buttons .btn-play:hover {
                    background: linear-gradient(135deg, #40a9ff, #69c0ff);
                    transform: scale(1.05);
                    box-shadow: 0 4px 12px rgba(24, 144, 255, 0.6);
                }
                .control-buttons .btn-play::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 0;
                    height: 0;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    transition: width 0.6s, height 0.6s;
                }
                .control-buttons .btn-play:hover::after {
                    width: 120px;
                    height: 120px;
                }
                
                /* 同时支持play-pause-btn类名，确保兼容性 */
                .control-buttons .play-pause-btn {
                    font-size: 24px;
                    width: 48px;
                    height: 48px;
                    background: linear-gradient(135deg, #1890ff, #40a9ff);
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.4);
                    position: relative;
                    overflow: hidden;
                }
                .control-buttons .play-pause-btn:hover {
                    background: linear-gradient(135deg, #40a9ff, #69c0ff);
                    transform: scale(1.05);
                    box-shadow: 0 4px 12px rgba(24, 144, 255, 0.6);
                }
                .control-buttons .play-pause-btn::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 0;
                    height: 0;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    transition: width 0.6s, height 0.6s;
                }
                .control-buttons .play-pause-btn:hover::after {
                    width: 120px;
                    height: 120px;
                }
                
                .progress-bar {
                    display: flex;
                    align-items: center;
                    width: 100%;
                }
                
                .progress-container {
                    flex: 1;
                    height: 4px;
                    background-color: rgba(255, 255, 255, 0.2);
                    border-radius: 2px;
                    margin: 0 10px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: height 0.3s ease;
                    position: relative;
                }
                .progress-container:hover {
                    height: 6px;
                }
                
                .progress {
                    height: 100%;
                    background: linear-gradient(to right, #1890ff, #69c0ff);
                    width: 0%;
                    transition: width 0.1s linear;
                    position: relative;
                }
                .progress::after {
                    content: '';
                    position: absolute;
                    right: -5px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 10px;
                    height: 10px;
                    background: white;
                    border-radius: 50%;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
                }
                .progress-container:hover .progress::after {
                    opacity: 1;
                }
                
                .time {
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    min-width: 35px;
                }
                
                /* 播放器选项区域在右侧 */
                .player-options {
                    display: flex;
                    align-items: center;
                    width: 200px;
                    flex-shrink: 0;
                    justify-content: flex-end;
                }
                
                .player-options .btn {
                    background: none;
                    border: none;
                    color: #ddd;
                    cursor: pointer;
                    font-size: 16px;
                    padding: 8px;
                    margin: 0 4px;
                    border-radius: 50%;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 32px;
                    height: 32px;
                    position: relative;
                }
                
                .player-options .btn:hover {
                    color: white;
                    background-color: rgba(255, 255, 255, 0.15);
                    transform: scale(1.1);
                }
                
                /* 音量控制区域美化 */
                .volume-control {
                    display: flex;
                    align-items: center;
                    margin: 0 4px;
                    position: relative;
                }
                
                .volume-slider-container {
                    position: relative;
                    width: 60px;
                    height: 4px;
                    background-color: rgba(255, 255, 255, 0.2);
                    border-radius: 2px;
                    margin-left: 6px;
                    overflow: hidden;
                    transition: width 0.3s ease;
                }
                
                .volume-control:hover .volume-slider-container {
                    width: 80px;
                }
                
                .volume-slider {
                    position: absolute;
                    left: 0;
                    top: 0;
                    height: 100%;
                    width: 70%;
                    background: linear-gradient(to right, #1890ff, #69c0ff);
                    transition: width 0.1s ease;
                }
                
                .volume-control {
                    display: flex;
                    align-items: center;
                    margin-right: 8px;
                }
                
                .volume-slider-container {
                    margin-left: 6px;
                    width: 80px;
                    height: 4px;
                    background-color: rgba(255, 255, 255, 0.2);
                    border-radius: 2px;
                    overflow: hidden;
                }
                
                .volume-slider {
                    height: 100%;
                    background-color: rgba(255, 255, 255, 0.8);
                    width: 70%;
                }
                
                /* 优化添加到歌单按钮 */
                .btn-add-to-playlist {
                    position: relative;
                    z-index: 10;
                }
                
                /* 移动端适配样式 */
                @media (max-width: 768px) {
                    /* 播放器容器 - 调整为更紧凑的布局 */
                    .music-player {
                        padding: 4px 8px !important;
                        height: auto !important;
                        min-height: 80px !important;
                        display: flex !important;
                        flex-direction: column !important;
                        align-items: stretch !important;
                        position: fixed !important;
                        bottom: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        z-index: 1000 !important;
                        background-color: rgba(0, 0, 0, 0.9) !important;
                        justify-content: flex-start !important;
                    }
                    
                    /* 重置电脑模式的固定宽度设置 */
                    .player-row,
                    .player-controls,
                    .player-options {
                        min-width: unset !important;
                        margin: 0 !important;
                        display: flex !important;
                    }
                    
                    /* 第一行：包含歌曲信息 */
                    .player-row {
                        order: 1 !important;
                        width: 100% !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: flex-start !important;
                        flex-wrap: nowrap !important;
                        margin-bottom: 4px !important;
                        padding-right: 120px !important; /* 为右侧的播放器选项留出空间 */
                    }
                    
                    /* 播放控制区域 */
                    .player-controls {
                        order: 2 !important;
                        width: 100% !important;
                        flex-direction: column !important;
                        align-items: center !important;
                        flex: 1 !important;
                    }
                    
                    /* 播放器选项区域 - 在手机模式下强制显示在第一行右侧 */
                    .player-options {
                        position: absolute !important;
                        top: 8px !important;
                        right: 16px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: flex-end !important;
                        width: auto !important;
                        flex-shrink: 0 !important;
                        margin: 0 !important;
                        z-index: 10 !important;
                    }
                    
                    /* 歌曲信息区域 - 占据主要空间 */
                    .song-info {
                        flex: 1;
                        margin-right: 8px;
                        display: flex;
                        align-items: center;
                        min-width: 0; /* 允许内容收缩 */
                    }
                    
                    /* 歌曲封面 */
                    .song-info img {
                        width: 40px !important;
                        height: 40px !important;
                        flex-shrink: 0 !important;
                        border-radius: 3px !important;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
                        margin-right: 0 !important;
                    }
                    
                    /* 歌曲详情 */
                    .song-details {
                        margin-left: 8px;
                        flex: 1;
                        min-width: 0; /* 允许文本区域收缩 */
                    }
                    
                    .song-details h3 {
                        font-size: 13px !important;
                        margin: 0 0 1px 0 !important;
                        white-space: nowrap !important;
                        overflow: hidden !important;
                        text-overflow: ellipsis !important;
                        font-weight: 500 !important;
                        color: #fff !important;
                    }
                    
                    .song-details p {
                        font-size: 11px !important;
                        margin: 0 !important;
                        white-space: nowrap !important;
                        overflow: hidden !important;
                        text-overflow: ellipsis !important;
                        opacity: 0.8 !important;
                        color: #ccc !important;
                    }
                    
                    /* 播放器选项按钮样式 */
                    .player-options .btn {
                        display: flex !important;
                        font-size: 12px !important;
                        margin-left: 4px !important;
                        width: 28px !important;
                        height: 28px !important;
                        padding: 0 !important;
                        flex-shrink: 0 !important;
                        align-items: center !important;
                        justify-content: center !important;
                        border-radius: 50% !important;
                        background: none !important;
                        border: none !important;
                        color: #fff !important;
                        cursor: pointer !important;
                    }
                    
                    /* 音量控制区域简化 */
                    .player-options .volume-control {
                        margin: 0 2px !important;
                    }
                    
                    .player-options .volume-slider-container {
                        width: 40px !important; /* 更小的音量条 */
                        margin-left: 4px !important;
                    }
                    
                    /* 优化添加到歌单按钮 */
                    .player-options .btn-add-to-playlist {
                        display: flex !important;
                        position: relative;
                        z-index: 10;
                        font-size: 14px !important;
                        background-color: rgba(255, 255, 255, 0.15);
                        border: 1px solid rgba(255, 255, 255, 0.25);
                    }
                    
                    /* 播放控制区域 */
                    .player-controls {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }
                    
                    .control-buttons {
                        display: flex !important;
                        justify-content: center !important;
                        align-items: center !important;
                        width: 100% !important;
                        margin-bottom: 4px !important;
                    }
                    
                    .control-buttons .btn {
                        margin: 0 6px !important;
                        font-size: 14px !important;
                        width: 32px !important;
                        height: 32px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        background: none !important;
                        border: none !important;
                        color: #fff !important;
                        cursor: pointer !important;
                        border-radius: 50% !important;
                    }
                    
                    /* 播放按钮更突出 - 同时支持两种类名 */
                    .control-buttons .play-pause-btn,
                    .control-buttons .btn-play {
                        font-size: 20px !important;
                        width: 36px !important;
                        height: 36px !important;
                        background-color: rgba(255, 255, 255, 0.2) !important;
                    }
                    
                    /* 进度条样式 */
                    .progress-bar {
                        display: flex !important;
                        align-items: center !important;
                        width: 100% !important;
                    }
                    
                    .time {
                        font-size: 10px !important;
                        min-width: 25px !important;
                        color: rgba(255, 255, 255, 0.8) !important;
                    }
                    
                    .progress-container {
                        margin: 0 6px !important;
                        flex: 1 !important;
                        height: 4px !important;
                        background-color: rgba(255, 255, 255, 0.2) !important;
                        border-radius: 2px !important;
                        overflow: hidden !important;
                        cursor: pointer !important;
                    }
                    
                    /* 在移动端隐藏音量滑块 */
                    .volume-control .volume-slider-container {
                        display: none !important;
                    }
                    
                    /* 确保弹窗在移动端正常显示 */
                    #add-to-playlist-modal .modal-content {
                        width: 95%;
                        margin: 20px;
                        max-height: 90vh;
                    }
                }
            </style>
        </footer>
    </div>

    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- Toast通知容器 -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- 添加到歌单弹窗 -->
    <div id="add-to-playlist-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加到歌单</h3>
                <button class="btn-close-modal"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="current-song-info" class="current-song-info">
                    <img src="" alt="歌曲封面" id="modal-song-cover">
                    <div class="song-details">
                        <h4 id="modal-song-name">歌曲名称</h4>
                        <p id="modal-song-artist">歌手</p>
                    </div>
                </div>
                <div class="playlist-selection">
                    <div id="playlists-loading" class="loading">加载中...</div>
                    <div id="playlists-container" class="playlists-container">
                        <!-- 歌单列表将通过JavaScript动态加载 -->
                    </div>
                    <div id="no-playlists" class="no-playlists" style="display: none;">
                        <p>您还没有歌单</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 添加到歌单弹窗样式 */
        #add-to-playlist-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #add-to-playlist-modal.show {
            display: flex;
        }
        
        #add-to-playlist-modal .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #add-to-playlist-modal .modal-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #add-to-playlist-modal .modal-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.2rem;
        }
        
        #add-to-playlist-modal .btn-close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        
        #add-to-playlist-modal .btn-close-modal:hover {
            color: #fff;
        }
        
        #add-to-playlist-modal .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        #add-to-playlist-modal .current-song-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        #add-to-playlist-modal .current-song-info img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        #add-to-playlist-modal .song-details h4 {
            margin: 0 0 5px 0;
            color: #fff;
            font-size: 1rem;
        }
        
        #add-to-playlist-modal .song-details p {
            margin: 0;
            color: #888;
            font-size: 0.9rem;
        }
        
        #add-to-playlist-modal .playlist-selection h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1rem;
        }
        
        #add-to-playlist-modal .playlists-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #add-to-playlist-modal .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #252525;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #add-to-playlist-modal .playlist-item:hover {
            background: #333;
        }
        
        #add-to-playlist-modal .playlist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 15px;
        }
        
        #add-to-playlist-modal .playlist-info {
            flex: 1;
        }
        
        #add-to-playlist-modal .playlist-info .playlist-name {
            color: #fff;
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        #add-to-playlist-modal .playlist-info .song-count {
            color: #888;
            font-size: 0.85rem;
        }
        
        #add-to-playlist-modal .loading {
            text-align: center;
            color: #888;
            padding: 40px 0;
        }
        
        #add-to-playlist-modal .no-playlists {
            text-align: center;
            padding: 40px 0;
            color: #888;
        }
        
        #add-to-playlist-modal .btn-primary {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        #add-to-playlist-modal .btn-primary:hover {
            background: #1177bb;
        }
        
        /* 隐藏滚动条但保持内容可滚动 */
        #add-to-playlist-modal .modal-body::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        #add-to-playlist-modal .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #add-to-playlist-modal .modal-body::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 0;
        }
        
        #add-to-playlist-modal .modal-body::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
    </style>

    <script>
        // Toast通知函数库
        const Toast = {
            // 主toast函数
            show: function(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                // 创建toast元素
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                // 设置图标
                let iconClass = 'fa-circle-info';
                switch(type) {
                    case 'success':
                        iconClass = 'fa-circle-check';
                        break;
                    case 'error':
                        iconClass = 'fa-circle-xmark';
                        break;
                    case 'warning':
                        iconClass = 'fa-circle-exclamation';
                        break;
                }
                
                // 设置HTML内容
                toast.innerHTML = `
                    <i class="fa-solid ${iconClass} toast-icon"></i>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                
                // 添加到容器
                container.appendChild(toast);
                
                // 显示动画
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // 自动隐藏
                const timer = setTimeout(() => {
                    this.hide(toast);
                }, duration);
                
                // 点击关闭按钮
                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => {
                    clearTimeout(timer);
                    this.hide(toast);
                });
                
                // 点击toast本身也可以关闭
                toast.addEventListener('click', (e) => {
                    if (e.target !== closeBtn && !closeBtn.contains(e.target)) {
                        clearTimeout(timer);
                        this.hide(toast);
                    }
                });
                
                return toast;
            },
            
            // 隐藏toast函数
            hide: function(toast) {
                toast.classList.remove('show');
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },
            
            // 快捷方法
            success: function(message, duration) {
                return this.show(message, 'success', duration);
            },
            
            error: function(message, duration) {
                return this.show(message, 'error', duration);
            },
            
            info: function(message, duration) {
                return this.show(message, 'info', duration);
            },
            
            warning: function(message, duration) {
                return this.show(message, 'warning', duration);
            }
        };
        
        // 为了兼容性，创建全局函数
        function showToast(message, type, duration) {
            return Toast.show(message, type, duration);
        }

        // 添加到歌单功能
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('add-to-playlist-modal');
            const addToPlaylistBtn = document.getElementById('add-to-playlist-btn');
            const closeModalBtn = document.querySelector('.btn-close-modal');
            const playlistsContainer = document.getElementById('playlists-container');
            const playlistsLoading = document.getElementById('playlists-loading');
            const noPlaylists = document.getElementById('no-playlists');
    
            
            let currentSongId = null;
            let currentSongInfo = null;
            
            // 获取当前播放歌曲信息
            function getCurrentPlayingSong() {
                const songInfo = document.querySelector('.music-player .song-info');
                if (!songInfo) return null;
                
                const songName = songInfo.querySelector('h3')?.textContent || '未知歌曲';
                const artist = songInfo.querySelector('p')?.textContent || '未知歌手';
                const coverElement = songInfo.querySelector('img');
                const coverUrl = coverElement ? coverElement.src : '/static/img/logo.png';
                
                // 假设audio元素存储了当前歌曲ID
                const audioElement = document.getElementById('audio-player');
                const songId = audioElement?.dataset.songId;
                
                return {
                    id: songId,
                    name: songName,
                    artist: artist,
                    cover: coverUrl
                };
            }
            
            // 显示弹窗
            function showModal() {
                currentSongInfo = getCurrentPlayingSong();
                if (!currentSongInfo || !currentSongInfo.id) {
                    showToast('没有正在播放的歌曲', 'error');
                    return;
                }
                
                currentSongId = currentSongInfo.id;
                
                // 更新弹窗中的歌曲信息
                document.getElementById('modal-song-name').textContent = currentSongInfo.name;
                document.getElementById('modal-song-artist').textContent = currentSongInfo.artist;
                document.getElementById('modal-song-cover').src = currentSongInfo.cover;
                
                // 加载用户歌单
                loadUserPlaylists();
                
                // 显示弹窗
                modal.classList.add('show');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            }
            
            // 隐藏弹窗
            function hideModal() {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            // 加载用户歌单
            function loadUserPlaylists() {
                playlistsLoading.style.display = 'block';
                playlistsContainer.style.display = 'none';
                noPlaylists.style.display = 'none';
                
                fetch('/user/playlists')
                    .then(response => {
                        if (!response.ok) throw new Error('获取歌单失败');
                        return response.json();
                    })
                    .then(data => {
                        playlistsLoading.style.display = 'none';
                        
                        if (data.playlists && data.playlists.length > 0) {
                            playlistsContainer.style.display = 'block';
                            renderPlaylists(data.playlists);
                        } else {
                            noPlaylists.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('加载歌单失败:', error);
                        playlistsLoading.style.display = 'none';
                        noPlaylists.style.display = 'block';
                        showToast('加载歌单失败', 'error');
                    });
            }
            
            // 渲染歌单列表
            function renderPlaylists(playlists) {
                playlistsContainer.innerHTML = '';
                
                playlists.forEach(playlist => {
                    const playlistItem = document.createElement('div');
                    playlistItem.className = 'playlist-item';
                    playlistItem.dataset.playlistId = playlist.id;
                    
                    playlistItem.innerHTML = `
                        <input type="checkbox" id="playlist-${playlist.id}">
                        <div class="playlist-info">
                            <div class="playlist-name">${playlist.name}</div>
                            <div class="song-count">${playlist.song_count}首</div>
                        </div>
                    `;
                    
                    // 添加点击事件
                    playlistItem.addEventListener('click', function(e) {
                        // 如果点击的是复选框，不要阻止事件冒泡
                        if (e.target.type === 'checkbox') return;
                        
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    });
                    
                    playlistsContainer.appendChild(playlistItem);
                });
                
                // 添加确认按钮
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary';
                confirmBtn.textContent = '确认添加';
                confirmBtn.style.marginTop = '20px';
                confirmBtn.style.width = '100%';
                confirmBtn.style.textAlign = 'center';
                confirmBtn.style.justifyContent = 'center';
                
                confirmBtn.addEventListener('click', addToSelectedPlaylists);
                playlistsContainer.appendChild(confirmBtn);
            }
            
            // 添加歌曲到选中的歌单
            function addToSelectedPlaylists() {
                const selectedPlaylists = [];
                playlistsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    const playlistId = checkbox.parentElement.dataset.playlistId;
                    const playlistName = checkbox.parentElement.querySelector('.playlist-name').textContent;
                    selectedPlaylists.push({ id: playlistId, name: playlistName });
                });
                
                if (selectedPlaylists.length === 0) {
                    showToast('请选择至少一个歌单', 'warning');
                    return;
                }
                
                // 依次添加到每个选中的歌单，单独处理每个请求，允许部分失败
                const promises = selectedPlaylists.map(playlist => {
                    return fetch(`/user/playlist/${playlist.id}/add_song`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ song_id: currentSongId })
                    })
                    .then(response => {
                        // 无论成功失败，都尝试解析JSON
                        return response.json().then(data => {
                            console.log(`歌单${playlist.name}响应数据:`, JSON.stringify(data));
                            // 返回处理结果，包含状态、数据和歌单信息
                            return {
                                status: response.ok ? 'fulfilled' : 'rejected',
                                playlist: playlist,
                                data: data,
                                error: !response.ok ? (data.message || '添加失败') : null
                            };
                        }).catch(error => {
                            console.error(`歌单${playlist.name}JSON解析错误:`, error);
                            return {
                                status: 'rejected',
                                playlist: playlist,
                                error: '添加失败，解析错误'
                            };
                        });
                    });
                });
                
                // 使用Promise.allSettled处理所有请求，无论成功失败都获取结果
                Promise.allSettled(promises)
                    .then(results => {
                        console.log('所有请求结果:', results);
                        
                        // 处理每个请求的结果
                        const successPlaylists = [];
                        const failedPlaylists = [];
                        
                        results.forEach(result => {
                            if (result.status === 'fulfilled' && result.value.status === 'fulfilled') {
                                // 成功添加的歌单
                                successPlaylists.push(result.value.playlist);
                                // 更新侧边栏歌单数量
                                if (typeof updateSidebarPlaylist === 'function') {
                                    const playlistElement = document.querySelector(`.playlist-item[data-playlist-id="${result.value.playlist.id}"]`);
                                    if (playlistElement) {
                                        const songCountElement = playlistElement.querySelector('.song-count');
                                        if (songCountElement) {
                                            const currentCount = parseInt(songCountElement.textContent) || 0;
                                            const newCount = currentCount + 1;
                                            updateSidebarPlaylist(result.value.playlist.id, null, newCount);
                                        }
                                    }
                                }
                            } else {
                                // 失败的歌单
                                failedPlaylists.push({
                                    name: result.value.playlist.name,
                                    error: result.value.error
                                });
                            }
                        });
                        
                        // 生成提示消息
                        let toastMessage = '';
                        let toastType = 'success';
                        
                        if (successPlaylists.length > 0 && failedPlaylists.length === 0) {
                            // 全部成功
                            toastMessage = successPlaylists.length === 1 
                                ? `歌曲已成功添加到歌单《${successPlaylists[0].name}》`
                                : `歌曲已成功添加到${successPlaylists.length}个歌单`;
                        } else if (successPlaylists.length === 0 && failedPlaylists.length > 0) {
                            // 全部失败
                            toastMessage = failedPlaylists.map(fp => `${fp.name}：${fp.error}`).join('；');
                            toastType = 'error';
                        } else {
                            // 部分成功，部分失败
                            toastMessage = `成功添加到${successPlaylists.length}个歌单；失败：${failedPlaylists.map(fp => `${fp.name}(${fp.error})`).join('、')}`;
                            toastType = 'warning';
                        }
                        
                        console.log('显示的toast消息:', toastMessage);
                        showToast(toastMessage, toastType);
                        
                        // 如果有成功的歌单，且updateSidebarPlaylist不存在，则重新加载整个歌单列表
                        if (successPlaylists.length > 0 && typeof updateSidebarPlaylist !== 'function' && typeof loadUserPlaylists === 'function') {
                            loadUserPlaylists();
                        }
                        
                        hideModal();
                    })
                    .catch(error => {
                        // 这个catch通常不会被触发，因为我们在Promise.allSettled中已经处理了所有情况
                        console.error('添加到歌单过程中发生错误:', error);
                        showToast('处理请求过程中发生错误，请重试', 'error');
                    });
            }
            
            // 创建新歌单 - 按钮已删除
            
            // 事件监听
            if (addToPlaylistBtn) addToPlaylistBtn.addEventListener('click', showModal);
            if (closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
            
            // 点击弹窗外部关闭弹窗
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideModal();
                }
            });
            
            // ESC键关闭弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    hideModal();
                }
            });
        });
    </script>
    
    <!-- 创建歌单弹窗 -->
    <div id="create-playlist-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>创建歌单</h3>
                <button id="close-modal-btn" class="modal-close-btn">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-playlist-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="playlist-name">歌单名称 <span class="required">*</span></label>
                        <input type="text" id="playlist-name" name="name" placeholder="请输入歌单名称" maxlength="100" required>
                        <small>歌单名称不能为空，最多100个字符</small>
                    </div>
                    <div class="form-group">
                        <label for="playlist-description">歌单描述（选填）</label>
                        <textarea id="playlist-description" name="description" placeholder="简单介绍一下你的歌单吧" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="playlist-cover">歌单封面（选填）</label>
                        <div class="cover-upload-container">
                            <div id="cover-preview" class="cover-preview">
                                <i class="fa-solid fa-music"></i>
                                <span>点击上传封面</span>
                            </div>
                            <input type="file" id="playlist-cover" name="cover" accept="image/*" style="display: none;">
                        </div>
                        <small>支持jpg、png、gif格式，大小不超过5MB</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-create-btn" class="btn btn-cancel">取消</button>
                <button id="confirm-create-btn" class="btn btn-primary" type="submit" form="create-playlist-form">创建</button>
            </div>
        </div>
    </div>

    <style>
        /* 弹窗样式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        /* Toast通知样式 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 12px 16px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 280px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #1db954;
        }
        
        .toast.error {
            background-color: #e74c3c;
        }
        
        .toast.info {
            background-color: #3498db;
        }
        
        .toast.warning {
            background-color: #f39c12;
        }
        
        .toast-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-message {
            flex-grow: 1;
            word-break: break-word;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        .modal-content {
            background-color: #1a1a1a;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #f0f0f0;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background-color: #333;
            color: #f0f0f0;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #f0f0f0;
        }
        
        .form-group .required {
            color: #e74c3c;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background-color: #333;
            border: 1px solid #555;
            color: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1db954;
            box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #888;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #888;
            font-size: 12px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #333;
            background-color: #222;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-cancel {
            background-color: #333;
            color: #ccc;
            border: 1px solid #555;
        }
        
        .btn-cancel:hover {
            background-color: #444;
            color: #f0f0f0;
        }
        
        .btn-primary {
            background-color: #1db954;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1aa34a;
        }
        
        .btn-primary:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        /* 侧边栏歌单封面图片样式 */
        .playlist-item .playlist-cover-img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* 创建歌单按钮样式 */
        .btn-create-playlist {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            width: 100%;
            background-color: transparent;
            border: 1px dashed #ccc;
            border-radius: 4px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-create-playlist:hover {
            background-color: #f5f5f5;
            border-color: #1db954;
            color: #1db954;
        }
    </style>

    <script>
        // 侧边栏切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const sidebar = document.querySelector('.sidebar');
            const mainView = document.querySelector('.main-view');
            
            // 切换侧边栏显示/隐藏
            function toggleSidebar() {
                sidebar.classList.toggle('sidebar-closed');
                
                if (sidebar.classList.contains('sidebar-closed')) {
                    mainView.classList.add('main-view-full');
                } else {
                    mainView.classList.remove('main-view-full');
                }
            }
            
            // 添加事件监听器
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleSidebar);
            
            // 点击主内容区域关闭侧边栏（仅在移动端）
            mainView.addEventListener('click', function(e) {
                // 确保点击的不是菜单按钮或其子元素
                if (!e.target.closest('.mobile-menu-btn') && window.innerWidth <= 768 && !sidebar.classList.contains('sidebar-closed')) {
                    sidebar.classList.add('sidebar-closed');
                    mainView.classList.add('main-view-full');
                }
            });
            
            // 窗口大小变化时调整布局
            
            // 创建歌单弹窗功能
            const createPlaylistBtn = document.getElementById('create-playlist-btn');
            const modal = document.getElementById('create-playlist-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelCreateBtn = document.getElementById('cancel-create-btn');
            const createPlaylistForm = document.getElementById('create-playlist-form');
            const userPlaylists = document.getElementById('user-playlists');
            const coverPreview = document.getElementById('cover-preview');
            const playlistCover = document.getElementById('playlist-cover');
            
            // 封面上传处理
            coverPreview.addEventListener('click', function() {
                playlistCover.click();
            });
            
            // 显示选择的封面图片
            playlistCover.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 检查文件大小
                    if (file.size > 5 * 1024 * 1024) {
                        Toast.error('图片大小不能超过5MB');
                        this.value = '';
                        return;
                    }
                    
                    // 检查文件类型
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        Toast.error('只支持jpg、png、gif格式图片');
                        this.value = '';
                        return;
                    }
                    
                    // 显示预览
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // 移除旧的图片和删除按钮
                        const oldImg = coverPreview.querySelector('img');
                        const oldRemoveBtn = coverPreview.querySelector('.cover-remove-btn');
                        if (oldImg) coverPreview.removeChild(oldImg);
                        if (oldRemoveBtn) coverPreview.removeChild(oldRemoveBtn);
                        
                        // 保存Base64格式的图片数据
                        window.playlistCoverBase64 = e.target.result;
                        
                        // 创建新图片
                        const img = document.createElement('img');
                        img.src = window.playlistCoverBase64;
                        coverPreview.appendChild(img);
                        coverPreview.classList.add('has-image');
                        
                        // 添加删除按钮
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'cover-remove-btn';
                        removeBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
                        removeBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            coverPreview.removeChild(img);
                            coverPreview.removeChild(removeBtn);
                            coverPreview.classList.remove('has-image');
                            playlistCover.value = '';
                            window.playlistCoverBase64 = '';
                        });
                        coverPreview.appendChild(removeBtn);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 显示弹窗
            function showModal() {
                modal.style.display = 'flex';
                // 自动聚焦到歌单名称输入框
                document.getElementById('playlist-name').focus();
            }
            
            // 隐藏弹窗
            function hideModal() {
                modal.style.display = 'none';
                // 重置表单
                createPlaylistForm.reset();
                // 重置封面预览
                const img = coverPreview.querySelector('img');
                const removeBtn = coverPreview.querySelector('.cover-remove-btn');
                if (img) coverPreview.removeChild(img);
                if (removeBtn) coverPreview.removeChild(removeBtn);
                coverPreview.classList.remove('has-image');
                window.playlistCoverBase64 = '';
            }
            
            // 处理点击弹窗外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideModal();
                }
            });
            
            // 处理ESC键关闭弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    hideModal();
                }
            });
            
            // 绑定事件监听器
            if (createPlaylistBtn) createPlaylistBtn.addEventListener('click', showModal);
            if (closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
            if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', hideModal);
            
            // 处理表单提交
            if (createPlaylistForm) {
                createPlaylistForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const playlistName = document.getElementById('playlist-name').value.trim();
                    const playlistDescription = document.getElementById('playlist-description').value.trim();
                    
                    // 显示加载状态
                    const confirmBtn = document.getElementById('confirm-create-btn');
                    const originalText = confirmBtn.innerHTML;
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 创建中...';
                    
                    // 创建JSON数据
                    const data = {
                        name: playlistName,
                        description: playlistDescription,
                        cover_url: window.playlistCoverBase64 || ''
                    };
                    
                    // 调用API创建歌单
                    fetch('/user/create_playlist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 恢复按钮状态
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = originalText;
                        
                        if (data.message === '歌单创建成功') {
                            // 显示成功提示
                            Toast.success('歌单创建成功！');
                            
                            // 隐藏弹窗
                            hideModal();
                            
                            // 重新加载用户歌单列表
                            if (typeof loadUserPlaylists === 'function') {
                                loadUserPlaylists();
                            } else {
                                // 如果loadUserPlaylists函数不存在，则简单刷新页面
                                location.reload();
                            }
                        } else {
                            // 显示错误信息
                            Toast.error(data.message || '创建歌单失败，请稍后重试');
                        }
                    })
                    .catch(error => {
                        // 恢复按钮状态
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = originalText;
                        
                        console.error('创建歌单请求失败:', error);
                    Toast.error('网络错误，请稍后重试');
                    });
                });
            }
            function handleResize() {
                if (window.innerWidth > 768) {
                    // 桌面端：显示侧边栏，主内容不占满
                    sidebar.classList.remove('sidebar-closed');
                    mainView.classList.remove('main-view-full');
                } else {
                    // 移动端：隐藏侧边栏，主内容占满
                    sidebar.classList.add('sidebar-closed');
                    mainView.classList.add('main-view-full');
                }
            }
            
            // 初始化布局
            handleResize();
            
            // 添加窗口大小变化事件监听
            window.addEventListener('resize', handleResize);
        });
    </script>
</body>
</html>
